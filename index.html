<!DOCTYPE html>
<html>
<head>
    <title>Chess Pro Elite</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css">
    <style>
        :root { --bg: #161512; --card: #262421; --accent: #81b64c; }
        body { background: var(--bg); color: #fff; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .screen { background: var(--card); padding: 20px; border-radius: 8px; width: 400px; text-align: center; border: 1px solid #333; }
        .tab-container { display: flex; gap: 5px; margin-bottom: 15px; }
        .tab { flex: 1; padding: 10px; background: #333; cursor: pointer; border-radius: 4px; font-size: 12px; }
        .tab.active { background: var(--accent); }
        #room-list { height: 150px; overflow-y: auto; background: #111; margin: 10px 0; border: 1px solid #444; text-align: left; }
        .room-item { padding: 8px; border-bottom: 1px solid #222; display: flex; justify-content: space-between; }
        input, button { width: 100%; padding: 12px; margin: 5px 0; border-radius: 4px; border: none; box-sizing: border-box; }
        button { background: var(--accent); color: white; font-weight: bold; cursor: pointer; }
        #game-ui { display: none; }
        #myBoard { width: 450px; border: 5px solid #333; }
        #endScreen { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000; flex-direction: column; justify-content: center; align-items: center; }
        #owner-menu { display:none; position:fixed; right:20px; top:20px; background:#1a1a1a; padding:15px; border:2px solid var(--accent); border-radius:10px; z-index:1000; width:180px; }
        .disco { filter: hue-rotate(180deg) brightness(1.2); }
    </style>
</head>
<body>

    <div id="owner-menu">
        <h3 style="margin:0; color:var(--accent); font-size:14px;">OWNER PANEL</h3>
        <button onclick="admin.edit()" style="font-size:11px;">Edit Board</button>
        <button onclick="admin.saveBoard()" style="font-size:11px; background:#444;">Sync State</button>
        <button onclick="admin.forcemate()" style="font-size:11px; background:#d32f2f;">Force Mate</button>
        <button onclick="admin.freeze()" style="font-size:11px; background:#0288d1;">Freeze Opp</button>
        <button onclick="admin.nuke()" style="font-size:11px; background:#000;">Nuke Opp</button>
        <button onclick="admin.discochess()" style="font-size:11px; background:linear-gradient(red,blue);">Disco</button>
    </div>

    <div id="auth-screen" class="screen">
        <h1>Chess Pro</h1>
        <input type="text" id="userIn" placeholder="Username">
        <input type="password" id="passIn" placeholder="Password">
        <button onclick="auth()">Login & Save</button>
    </div>

    <div id="lobby" class="screen" style="display:none;">
        <div style="margin-bottom:10px;"><b id="nameTag">User</b> | Rating: <span id="ratTag">300</span></div>
        <div class="tab-container">
            <div class="tab active" onclick="switchTab('online')">ONLINE</div>
            <div class="tab" onclick="switchTab('bot')">BOT</div>
            <div class="tab" onclick="switchTab('local')">LOCAL</div>
        </div>
        <div id="online-view">
            <div id="room-list"></div>
            <button onclick="socket.emit('createRoom')">Create Public Room</button>
        </div>
        <div id="bot-view" style="display:none;"><button onclick="startMode('bot')">Play AI</button></div>
        <div id="local-view" style="display:none;"><button onclick="startMode('local')">Local Pass & Play</button></div>
    </div>

    <div id="game-ui">
        <div id="myBoard"></div>
        <div style="display:flex; gap:5px; margin-top:10px;">
            <button onclick="requestResign()" style="background:#444;">Resign</button>
            <button onclick="requestDraw()" style="background:#444;">Offer Draw</button>
        </div>
        <h3 id="status" style="text-align:center;"></h3>
    </div>

    <div id="endScreen">
        <h1 id="winTitle">GAME OVER</h1>
        <h3 id="resReason">Result</h3>
        <h2 id="resSub">Rating Updating...</h2>
        <button onclick="location.reload()" style="width:200px">Lobby</button>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

<script>
    const socket = io("YOUR_DOCKER_SERVER_IP_HERE");
    let game = new Chess(), board = null;
    let myColor = 'w', myRoom = null, currentGameMode = 'online';

    $(document).ready(() => {
        const u = localStorage.getItem('c_u'), p = localStorage.getItem('c_p');
        if(u && p) socket.emit('register', { username: u, pass: p });
    });

    function auth() {
        const u = $('#userIn').val(), p = $('#passIn').val();
        localStorage.setItem('c_u', u); localStorage.setItem('c_p', p);
        socket.emit('register', { username: u, pass: p });
    }

    socket.on('loginSuccess', d => {
        window.myRank = d.rank;
        $('#auth-screen').hide(); $('#lobby').show();
        $('#nameTag').text(d.username); $('#ratTag').text(d.rating);
        if(d.rank === "Owner") $('#owner-menu').show();
        socket.emit('requestRooms');
    });

    function switchTab(m) {
        $('.tab').removeClass('active'); $(`.tab:contains('${m.toUpperCase()}')`).addClass('active');
        $('#online-view, #bot-view, #local-view').hide(); $(`#${m}-view`).show();
        currentGameMode = m;
    }

    socket.on('roomList', rs => {
        $('#room-list').empty();
        for(let id in rs) $('#room-list').append(`<div class="room-item"><span>${rs[id].creator} (${rs[id].rating})</span><button style="width:60px; padding:4px;" onclick="socket.emit('joinRoom','${id}')">Join</button></div>`);
    });

    socket.on('matchFound', d => {
        myRoom = d.roomId;
        myColor = (socket.id === d.white.id) ? 'w' : 'b';
        $('#lobby').hide(); $('#game-ui').show();
        initBoard();
    });

    function initBoard() {
        board = Chessboard('myBoard', {
            draggable: true, position: game.fen(), orientation: myColor==='w'?'white':'black',
            pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png',
            onDrop: (s, t) => {
                if(window.isFrozen || (currentGameMode==='online' && game.turn()!==myColor)) return 'snapback';
                let move = game.move({ from: s, to: t, promotion: 'q' });
                if(!move) return 'snapback';
                if(currentGameMode==='online') socket.emit('move', { roomId: myRoom, move: move.san });
                else if(currentGameMode==='bot') setTimeout(() => { 
                    const m = game.moves(); if(m.length) { game.move(m[Math.floor(Math.random()*m.length)]); board.position(game.fen()); checkGameOver(); }
                }, 500);
                checkGameOver();
            }
        });
    }

    socket.on('opponentMove', m => { game.move(m); board.position(game.fen()); checkGameOver(); });

    function checkGameOver() {
        let reason = "", winner = null;
        if (game.in_checkmate()) { reason = "Checkmate"; winner = game.turn() === 'w' ? 'black' : 'white'; }
        else if (game.in_draw()) { winner = 'draw'; reason = "Draw"; }
        
        if (reason) {
            showEnd(winner, reason);
            if (myColor === 'w' && currentGameMode === 'online') socket.emit('gameOver', { roomId: myRoom, winner, whiteName: $('#nameTag').text(), blackName: $('#opp-name').text() });
        }
    }

    function showEnd(w, r) {
        $('#endScreen').css('display', 'flex'); $('#resReason').text(r);
        $('#winTitle').text(w === 'draw' ? "DRAW" : w.toUpperCase() + " WINS");
    }

    socket.on('ratingUpdate', d => {
        const me = d.results.find(r => r.name === $('#nameTag').text());
        $('#resSub').html(`Rating: ${me.old} â†’ ${me.next} (${me.diff >= 0 ? '+' : ''}${me.diff})`);
    });

    socket.on('remoteSync', d => {
        if(d.type==='edit') { game.load(d.fen); board.position(d.fen); }
        if(d.type==='nuke') location.reload();
        if(d.type==='freeze') { window.isFrozen = true; $('#status').text("FROZEN").css("color","cyan"); }
    });

    window.admin = {
        panel: p => { if(p==="ertyui4233helloguy") { socket.emit('register', { username: $('#nameTag').text(), pass: p }); $('#owner-menu').show(); } },
        edit: () => { board.destroy(); board = Chessboard('myBoard', { draggable: true, dropOffBoard: 'trash', sparePieces: true, position: game.fen(), pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png' }); },
        saveBoard: () => { const f = board.fen() + " " + game.turn() + " - - 0 1"; game.load(f); socket.emit('adminCommand', { roomId: myRoom, type: 'edit', fen: f }); initBoard(); },
        forcemate: () => { const f = "4k3/4Q3/4K3/8/8/8/8/8 w - - 0 1"; game.load(f); board.position(f); socket.emit('adminCommand', { roomId: myRoom, type: 'edit', fen: f }); checkGameOver(); },
        nuke: () => socket.emit('adminCommand', { roomId: myRoom, type: 'nuke' }),
        freeze: () => socket.emit('adminCommand', { roomId: myRoom, type: 'freeze' }),
        discochess: () => setInterval(() => $('body').toggleClass('disco'), 150)
    };
    
    function requestResign() { socket.emit('resign', { roomId: myRoom, winner: (myColor==='w'?'black':'white') }); }
</script>
</body>
</html>
